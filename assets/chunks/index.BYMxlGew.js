import{L as j,M as N,I as Y,S as Z,v as z,R as F,a as G,T as V}from"./index.Px0uC6sZ.js";let I=0;function A(){return{type:"element",install(e){const t=e,n=[],a=e.emitter,r={create(o){I++;const{type:l,...i}=o,s=r.getLayerByType(l);if(!s)return;const u=i.id!==void 0?i.id:I,c=s.create({...i,id:u});return c?(r.add(c),c.getSElement().setProps({appLayerType:l,appElementId:c.id}),a.emit("element:created",c),c):void 0},add(o){if(!o)return;const l=Array.isArray(o)?o:[o];for(const i of l){const s=r.getLayerByType(i.type);if(!s)return;s.add(i)}a.emit("element:added",l)},remove(o){if(!o)return;const l=Array.isArray(o)?o:[o];for(const i of l){const s=r.getLayerByType(i.type);if(!s)return;s.remove(i)}a.emit("element:removed",l)},getLayers(){return n},getLayerById(o){return n.find(l=>l.id===o)},getLayerByType(o){return n.find(l=>l.type===o)},addLayer(o){n.push(o)},removeLayer(o){const l=n.findIndex(i=>i.id===o.id);l!==-1&&n.splice(l,1)}};return t.element=r,t}}}var f=(e=>(e.create="element:created",e.add="element:added",e.update="element:update",e.remove="element:removed",e))(f||{});let k=0,D=0;function P(e,t){k++;const{container:{layerManager:n}}=e.map,a=n.create({}),r=[];return{id:k,name:t.name,type:t.type,sElementType:t.sElementType,create(o){return t.createElement(e,a,o)},add(o){r.findIndex(l=>l.id===o.id)===-1&&(a.add(o.getSElement()),r.push(o))},remove(o){const l=r.findIndex(i=>i.id===o.id);l!==-1&&(a.remove(o.getSElement()),r.splice(l,1))},getElements(){return r},getElementById(o){return r.find(l=>l.id===o)}}}function _(e,t,n){D++;const a=t.create({type:n.sElementType,data:n.data,rotate:n.rotate,style:n.style},!1);return{id:n.id??D,type:n.type,name:n.name,get props(){return a.props},setProps(r){return a.setProps(r)},setName(r){a.setName(r)},get rotate(){return a.rotate},setRotate(r){return a.setRotate(r)},getSElement(){return a},get style(){return a.style},setStyle(r){a.setStyle(r)},get data(){return a.data},setData(r){a.setData(r)}}}function w(e,t){const n=t.props.appLayerType,a=t.props.appElementId,r=e.element.getLayerByType(n);if(!r)return;const o=r.getElementById(a);if(o)return o}function x(e,t){const n=[],a=[];for(const r of t){const o=r.getOlFeature().getGeometry();if(!o)continue;const l=Y(o),i=w(e,r);i&&l&&(n.push(i),a.push({element:i,data:{data:l}}))}return M(a,e.emitter),n}function $(e){const t=e.element,n=e.data;n.data&&t.setData(n.data),n.name&&t.setName(n.name),n.rotate&&t.setRotate(n.rotate),n.style&&t.setStyle(n.style)}function M(e,t,n=!0){if(t.emit(f.update,e),!!n)for(const a of e)$(a)}const C="#f0fae6",E="ap";function H(e,t,n){return _(e,t,{...n,type:E,sElementType:"circle",style:{fill:{color:C}}})}function R(){let e;return{type:E,install(t){e=t;const n=P(e,{type:E,createElement:H,sElementType:["circle"]});return e.element.addLayer(n),e}}}const U="#f0fae6",S="area";function W(e,t,n){return _(e,t,{...n,type:S,style:{fill:{color:U}}})}function O(){let e;return{type:S,install(t){e=t;const n=P(e,{type:S,createElement:W,sElementType:["rect","polygon","circle"]});return e.element.addLayer(n),e}}}const Pe=Object.freeze(Object.defineProperty({__proto__:null,ElementEmitter:f,createApPlugin:R,createAreaPlugin:O,createElementPlugin:A,getElementBySElement:w,setElementsData:M,syncElementsDataEmit:x},Symbol.toStringTag,{value:"Module"}));function q(){let e;return{type:"tool",install(t){return e=t,e.tools={},e}}}function J(e){const{interactiveManager:t,emitter:n}=e.map;function a(l){e.emitter.emit("measure",l)}const r=V(t),o={enabled:!1,enable(){o.enabled||(o.enabled=!0,n.on("measure",a),r.enable())},use(l){r.use(l)},close(){o.enabled&&(o.enabled=!1,n.remove("measure",a),r.close())}};return o}function K(){let e;return{type:"measure",install(t){return e=t,e.tools.measure=J(e),e}}}function Q(e){var t;const{interactiveManager:n,emitter:a}=e.map,r=G(n);let o=((t=e.element.getLayers())==null?void 0:t[0]).type,l;function i(u){const c=e.element.create({type:o,data:u.data,sElementType:l});e.emitter.emit("draw",c)}const s={enabled:!1,enable(){s.enabled||(s.enabled=!0,a.on("draw",i),s.use(o),r.enable())},use(u,c){o=u;const d=e.element.getLayerByType(o);d&&(l=c??d.sElementType[0],!(!l||!d.sElementType.includes(l))&&r.use(l))},close(){s.enabled&&(s.enabled=!1,a.remove("draw",i),r.close())}};return s}function ee(){let e;return{type:"draw",install(t){return e=t,e.tools.draw=Q(e),e}}}function te(e){const{interactiveManager:t,emitter:n}=e.map,a=F(t);let r=[];function o(i){const s=Array.isArray(i)?i:[];r=[];for(const u of s){const c=w(e,u);c&&r.push(c)}e.emitter.emit("element:select",r)}const l={enabled:!1,enable(){l.enabled||(l.enabled=!0,a.enable(),n.on("element:select",o))},add(i){a.add(i.getSElement())},remove(i){a.remove(i.getSElement())},getSelected(){return r},clean(){a.clean()},close(){l.enabled&&(l.enabled=!1,a.clean(),n.remove("element:select",o),a.close())}};return l}function ne(){let e;return{type:"select",install(t){return e=t,e.tools.select=te(e),e}}}function ae(e){const{interactiveManager:t,emitter:n}=e.map,a=z(t,!1),{select:r}=e.tools;function o(s){if(!s||s.length===0)return;const u=x(e,s);e.emitter.emit("element:move",u)}e.emitter.on("element:select",s=>{i.clean();for(const u of s)i.add(u)});let l=[];const i={enabled:!1,add(s){!s||l.findIndex(u=>u.id===s.id)!==-1||(a.add(s.getSElement()),l.push(s))},remove(s){if(!s)return;const u=l.findIndex(c=>c.id===s.id);u!==-1&&(a.remove(s.getSElement()),l.splice(u,1))},clean(){a.clean(),l=[]},enable(){i.enabled||(i.enabled=!0,n.on("element:move",o),a.enable(),r.enable())},close(){i.enabled&&(i.enabled=!1,n.remove("element:move",o),a.close(),r.close())}};return i}function re(){let e;return{type:"move",install(t){return e=t,e.tools.move=ae(e),e}}}function oe(e){const{interactiveManager:t,emitter:n}=e.map,a=Z(t,!1),{select:r}=e.tools;function o(s){if(!s||s.length===0)return;const u=x(e,s);e.emitter.emit("element:modify",u)}e.emitter.on("element:select",s=>{i.clean();for(const u of s)i.add(u)});let l=[];const i={enabled:!1,add(s){l.findIndex(u=>u.id===s.id)===-1&&(a.add(s.getSElement()),l.push(s))},remove(s){a.remove(s.getSElement());const u=l.findIndex(c=>c.id===s.id);u!==-1&&l.splice(u,1)},clean(){a.clean(),l=[]},enable(){i.enabled||(i.enabled=!0,n.on("element:modify",o),a.enable(),r.enable())},close(){i.enabled&&(i.enabled=!1,n.remove("element:modify",o),a.close(),r.close())}};return i}function le(){let e;return{type:"modify",install(t){return e=t,e.tools.modify=oe(e),e}}}function se(e){const t=e.tools.move,n=e.tools.modify;function a(o){e.emitter.emit("element:edit",o)}const r={enabled:!1,enable(){r.enabled||(r.enabled=!0,t.enable(),n.enable(),e.emitter.on("element:move",a),e.emitter.on("element:modify",a))},close(){r.enabled&&(r.enabled=!1,t.clean(),n.clean(),t.close(),n.close(),e.emitter.remove("element:move",a),e.emitter.remove("element:modify",a))}};return r}function ie(){let e;return{type:"edit",depend:["select","move","modify"],install(t){return e=t,e.tools.edit=se(e),e}}}function g(e,t=new WeakMap){if(e===null||typeof e!="object")return e;if(e instanceof Date)return new Date(e);if(e instanceof RegExp)return new RegExp(e);if(t.has(e))return t.get(e);const n=new e.constructor;return t.set(e,n),Array.isArray(e)?e.forEach((a,r)=>{n[r]=g(a,t)}):Object.keys(e).forEach(a=>{n[a]=g(e[a],t)}),n}function T(e){return e==null}function ce(e,t){const n=t.data.map(a=>a.element);e.element.add(n)}function ue(e,t){const n=t.data.map(a=>a.element);e.element.remove(n)}function B(e,t,n=!1){var a,r,o,l;const i=[];for(const s of t.data){if((a=s.data)!=null&&a.data){const u=s.rawData.data,c=s.data.data;s.element.setData(n?u:c)}if((r=s.data)!=null&&r.style){const u=s.rawData.style,c=s.data.style;s.element.setStyle(n?u:c)}if((o=s.data)!=null&&o.name){const u=s.rawData.name,c=s.data.name;s.element.setName(n?u:c)}if((l=s.data)!=null&&l.rotate){const u=s.rawData.rotate,c=s.data.rotate;s.element.setRotate(n?u:c)}i.push(s.element)}return i}function de(e){let t=[],n=-1,a=!1;function r(c){if(t.length>=50){t.shift(),t.push(c);return}t=t.slice(0,n+1),t.push(c),n++}function o(c){a=!0;const d=t[n];c==="next"&&d.type==="add"||c==="back"&&d.type==="remove"?ce(e,d):c==="next"&&d.type==="remove"||c==="back"&&d.type==="add"?ue(e,d):d.type==="update"&&(c==="next"?B(e,d,!1):B(e,d,!0)),e.emitter.emit("history",{max:50,pointer:n,data:d.data,type:d.type}),a=!1}function l(c){if(a)return;const d=[];for(const m of c)d.push({element:m});r({type:"add",data:d})}function i(c){if(a)return;const d=[];for(const m of c)d.push({element:m.element,rawData:{data:g(m.element.data),style:g(m.element.style),name:g(m.element.name),rotate:g(m.element.rotate)},data:m.data});r({type:"update",data:d})}function s(c){if(a)return;const d=[];for(const m of c)d.push({element:m});r({type:"remove",data:d})}const u={enabled:!1,enable(){u.enabled||(e.emitter.on(f.add,l),e.emitter.on(f.remove,s),e.emitter.on(f.update,i),u.enabled=!0)},close(){u.enabled&&(e.emitter.remove(f.add,l),e.emitter.remove(f.remove,s),e.emitter.remove(f.update,i),u.enabled=!1)},next(){n!==t.length-1&&(n++,o("next"))},back(){n!==-1&&(o("back"),n--)},clean(){t=[]}};return u}function me(){let e;return{type:"history",install(t){return e=t,e.tools.history=de(e),e}}}function fe(e){const{emitter:t}=e.map;function n(o){e.emitter.emit("click",o)}function a(o){e.emitter.emit("move",o)}const r={enabled:!1,enable(){r.enabled||(r.enabled=!0,t.on("click",n),t.on("move",a))},close(){r.enabled&&(r.enabled=!1,t.remove("click",n),t.remove("move",a))}};return r}function pe(){let e;return{type:"event",install(t){return e=t,e.tools.event=fe(e),e}}}function ye(e){const[t,n]=e;if(t<=0)return[0,1];const a=Math.log2(t),r=a+n;let o;return 2**r>1?o=3:2**r===1?o=2:o=1,[a,o]}let h=[.25,8],y=1;function be(e){const{view:t,baseMap:n}=e,a=n.getExtent(),r={enabled:!1,enable(){r.enabled||(r.enabled=!0)},setView(o){if(!r.enabled)return;h=ye(o);const[l,i]=h,s=t.getZoom();t.setMaxZoom(s+i),t.setMinZoom(s+l),e.emitter.emit("scale",{scale:y,range:h})},fit(o){if(!r.enabled)return;y=o;const l=a[3]-a[0],i=(l-l/y)/2,s=i,u=i,c=i+l/y,d=i+l/y;t.fit([s,u,c,d]),e.emitter.emit("scale",{scale:y,range:h})},close(){r.enabled&&(r.enabled=!1)}};return r}function ge(){let e;return{type:"scale",install(t){return e=t,e.tools.scale=be(e),e}}}function b(e,t){const n=t.getSElement();let a;if(n.type==="circle"){const r=n.data.radius;e==="left"&&(a=n.data.center[0]-r),e==="right"&&(a=n.data.center[0]+r),e==="top"&&(a=n.data.center[1]+r),e==="bottom"&&(a=n.data.center[1]-r)}else for(const r of n.data){if(e==="left"||e==="right"){if(T(a)){a=r[0];continue}if(e==="left"){a=a<r[0]?a:r[0];continue}if(e==="right"){a=a>r[0]?a:r[0];continue}}if(e==="top"||e==="bottom"){if(T(a)){a=r[1];continue}if(e==="top"){a=a>r[1]?a:r[1];continue}if(e==="bottom"){a=a<r[1]?a:r[1];continue}}}return a}function p(e,t){let n;for(const a of t){let r=!1;const o=b(e,a);if(T(n)){n=o;continue}e==="left"&&(r=n>o),e==="right"&&(r=n<o),e==="top"&&(r=n<o),e==="bottom"&&(r=n>o),r&&(n=o)}return n}function v(e,t,n,a){const r=[];for(const o of a){const l=o.getSElement(),i=b(e,o),s=n-i;let u=[];if(l.type==="circle"){let c,d;(e==="left"||e==="right")&&(c=l.data.center[0]+s,d=l.data.center[1]),(e==="top"||e==="bottom")&&(c=l.data.center[0],d=l.data.center[1]+s),e==="centerX"&&(c=n,d=l.data.center[1]),e==="centerY"&&(c=l.data.center[0],d=n),u={radius:l.data.radius,center:[c,d]}}else{if(u=[],e==="left"||e==="right")for(const c of l.data)u.push([c[0]+s,c[1]]);if(e==="top"||e==="bottom")for(const c of l.data)u.push([c[0],c[1]+s]);if(e==="centerX"){const c=b("left",o),d=(b("right",o)+c)/2-n;for(const m of l.data)u.push([m[0]-d,m[1]])}if(e==="centerY"){const c=b("top",o),d=b("bottom",o),m=(c+d)/2-n;for(const L of l.data)u.push([L[0],L[1]-m])}}r.push({element:o,data:{data:u}})}M(r,t.emitter),t.emitter.emit("rank",{elements:a,type:e,extreme:n})}function ve(e,t){const n=p("left",t);v("left",e,n,t)}function he(e,t){const n=p("right",t);v("right",e,n,t)}function Ee(e,t){const n=p("top",t);v("top",e,n,t)}function Se(e,t){const n=p("bottom",t);v("bottom",e,n,t)}function Te(e,t){const n=p("left",t),a=p("right",t),r=(n+a)/2;v("centerX",e,r,t)}function we(e,t){const n=p("top",t),a=p("bottom",t),r=(n+a)/2;v("centerY",e,r,t)}function xe(e){const t=e.tools.select,n={enabled:!1,enable(){n.enabled||(n.enabled=!0)},use(a){if(!n.enabled)return;const r=t.getSelected();if(!(r.length<2)){if(a==="left"){ve(e,r);return}if(a==="right"){he(e,r);return}if(a==="centerX"){Te(e,r);return}if(a==="centerY"){we(e,r);return}if(a==="top"){Ee(e,r);return}if(a==="bottom"){Se(e,r);return}}},close(){n.enabled&&(n.enabled=!1)}};return n}function Me(){let e;return{type:"rank",depend:["select"],install(t){return e=t,e.tools.rank=xe(e),e}}}const X={ap:R(),area:O(),measure:K(),draw:ee(),select:ne(),move:re(),modify:le(),edit:ie(),history:me(),event:pe(),scale:ge(),rank:Me()},Le=[{type:"ap"},{type:"area"}],Ie=[{type:"measure"},{type:"draw"},{type:"select"},{type:"move"},{type:"modify"},{type:"edit"},{type:"history"},{type:"event"},{type:"scale"},{type:"rank"}];function ke(e,t){for(const n of t)if(!e.getPluginByType(n))return!1;return!0}function De(e,t,n){if(t.depend&&t.depend.length>0){for(const a of t.depend){const r=X[a];r&&e.use(r,n)}return ke(e,t.depend)}return!0}function Be(e,t){const n=t??Le.concat(Ie);e.use(A()),e.use(q());for(const a of n){const r=X[a.type];e.use(r,t)}}function _e(e){const t=j({el:e.el,baseMap:e.baseMap,view:e.view}),{container:{baseMap:n},view:a}=t,r=[],o=N.emitter.createEmitter(),l={baseMap:n,view:a,emitter:o,get plugins(){return r},get map(){return t},getPluginByType(i){return r.find(s=>s.type===i)},use(i,s){return l.getPluginByType(i.type)||!De(l,i,s)||(i.install(l,s),r.push(i)),l}};return Be(l,e.plugins),l}export{Pe as O,_e as X};
