import{g as P,c as B,a as S}from"./index.p3HzktB-.js";import{c as $}from"./measure.CY19O_Fk.js";import{c as M}from"./draw.c6OZsDtu.js";import{c as k}from"./select.Qwx2Pf7f.js";import{c as x}from"./move.BBjKnOMc.js";import{c as D}from"./modify.CoEMxwzm.js";let g=0;function R(){return{type:"element",install(t){const o=t,n=[],r=t.emitter,i={create(l){g++;const{type:a,...c}=l,s=i.getLayerByType(a);if(!s)return;const m=c.id!==void 0?c.id:g,u=s.create({...c,id:m});return u?(i.add(u),u.getSElement().setProps({appLayerType:a,appElementId:u.id}),r.emit("element:created",u),u):void 0},add(l){const a=i.getLayerByType(l.type);a&&(a.add(l),r.emit("element:added",l))},remove(l){i.getLayerByType(l.type).remove(l),r.emit("element:removed",l)},getLayers(){return n},getLayerById(l){return n.find(c=>c.id===l)},getLayerByType(l){return n.find(c=>c.type===l)},addLayer(l){n.push(l)},removeLayer(l){const a=n.findIndex(c=>c.id===l.id);a!==-1&&n.splice(a,1)}};return o.element=i,o}}}function p(e,t){const o=t.props.appLayerType,n=t.props.appElementId,r=e.element.getLayerByType(o);if(!r)return;const i=r.getElementById(n);if(i)return i}let b=0,v=0;function O(e,t){b++;const{container:{layerManager:o}}=e.map,n=o.create({}),r=[];return{id:b,type:"ap",sElementType:"circle",create(l){return t.createElement(e,n,l)},add(l){r.findIndex(c=>c.id===l.id)===-1&&(n.add(l.getSElement()),r.push(l))},remove(l){const a=r.findIndex(c=>c.id===l.id);a!==-1&&(n.remove(l.getSElement()),r.splice(a,1))},getElements(){return r},getElementById(l){return r.find(c=>c.id===l)}}}function N(e,t,o){v++;const n={id:o.id??v,type:"ap",name:o.name,setName(r){e.emitter.emit("element:updateBefore",{element:n,name:r}),t.setName(r)},get rotate(){return t.rotate},setRotate(r){return e.emitter.emit("element:updateBefore",{element:n,rotate:r}),t.setRotate(r)},getSElement(){return t},get style(){return t.style},setStyle(r){e.emitter.emit("element:updateBefore",{element:n,style:r}),t.setStyle(r)},get data(){return t.data},setData(r){e.emitter.emit("element:updateBefore",{element:n,data:r}),t.setData(r)}};return n}function h(e,t){const n=t.getOlFeature().getGeometry();if(n){const r=P(n);e.setData(r)}}const C="#f0fae6";function A(e,t,o){const n=t.create({type:"circle",data:o.data,rotate:o.rotate,style:{fill:{color:C}}});return N(e,n,o)}function F(){let e;return{type:"ap",install(o){e=o;const n=O(e,{createElement:A});return e.element.addLayer(n),e}}}function j(){let e;return{type:"tool",install(o){return e=o,e.tools={},e}}}function G(e){const{interactiveManager:t,emitter:o}=e.map;function n(l){e.emitter.emit("measure",l)}const r=$(t),i={enabled:!1,enable(){i.enabled||(i.enabled=!0,o.on("measure",n),r.enable())},use(l){r.use(l)},close(){i.enabled&&(i.enabled=!1,o.remove("measure",n),r.close())}};return i}function W(){let e;return{type:"measure",install(o){return e=o,e.tools.measure=G(e),e}}}function q(e){var c;const{interactiveManager:t,emitter:o}=e.map,n=M(t),r=(c=e.element.getLayers())==null?void 0:c[0];let i=r==null?void 0:r.type;function l(s){const m=e.element.create({type:i,data:s.data});e.emitter.emit("draw",m)}const a={enabled:!1,enable(){a.enabled||(a.enabled=!0,o.on("draw",l),a.use(i),n.enable())},use(s){i=s;const m=e.element.getLayerByType(i);m&&n.use(m.sElementType)},close(){a.enabled&&(a.enabled=!1,o.remove("draw",l),n.close())}};return a}function z(){let e;return{type:"draw",install(o){return e=o,e.tools.draw=q(e),e}}}function H(e){const{interactiveManager:t,emitter:o}=e.map,n=k(t);function r(l){if(!l||l.length===0)return;const a=[];for(const c of l){const s=p(e,c);s&&a.push(s)}e.emitter.emit("select",a)}const i={enabled:!1,enable(){i.enabled||(i.enabled=!0,n.enable(),o.on("select",r))},close(){i.enabled&&(i.enabled=!1,o.remove("select",r),n.close())}};return i}function J(){let e;return{type:"select",install(o){return e=o,e.tools.select=H(e),e}}}function K(e){const{interactiveManager:t,emitter:o}=e.map,n=x(t,!1);function r(a){if(!a||a.length===0)return;const c=[];for(const s of a){const m=p(e,s);m&&(h(m,s),c.push(m))}e.emitter.emit("move",c)}const i=[],l={enabled:!1,add(a){i.findIndex(s=>s.id===a.id)===-1&&(n.add(a.getSElement()),i.push(a))},remove(a){n.remove(a.getSElement());const c=i.findIndex(s=>s.id===a.id);c!==-1&&i.splice(c,1)},clean(){for(const a of i)l.remove(a)},enable(){l.enabled||(l.enabled=!0,n.enable(),o.on("move",r))},close(){l.enabled&&(l.enabled=!1,o.remove("move",r),n.close())}};return l}function Q(){let e;return{type:"move",install(o){return e=o,e.tools.move=K(e),e}}}function U(e){const{interactiveManager:t,emitter:o}=e.map,n=D(t,!1);function r(a){if(!a||a.length===0)return;const c=[];for(const s of a){const m=p(e,s);m&&(h(m,s),c.push(m))}e.emitter.emit("modify",c)}const i=[],l={enabled:!1,add(a){i.findIndex(s=>s.id===a.id)===-1&&(n.add(a.getSElement()),i.push(a))},remove(a){n.remove(a.getSElement());const c=i.findIndex(s=>s.id===a.id);c!==-1&&i.splice(c,1)},clean(){for(const a of i)l.remove(a)},enable(){l.enabled||(l.enabled=!0,n.enable(),o.on("modify",r))},close(){l.enabled&&(l.enabled=!1,o.remove("modify",r),n.close())}};return l}function V(){let e;return{type:"modify",install(o){return e=o,e.tools.modify=U(e),e}}}function X(e){const t=e.tools.select,o=e.tools.move,n=e.tools.modify;function r(a){e.emitter.emit("edit",a)}function i(a){o.clean(),n.clean();for(const c of a)o.add(c),n.add(c)}const l={enabled:!1,enable(){l.enabled||(l.enabled=!0,t.enable(),o.enable(),n.enable(),e.emitter.on("select",i),e.emitter.on("move",r),e.emitter.on("modify",r))},close(){l.enabled&&(l.enabled=!1,o.clean(),n.clean(),t.close(),o.close(),n.close(),e.emitter.on("select",i),e.emitter.remove("move",r),e.emitter.remove("modify",r))}};return l}function Y(){let e;return{type:"edit",depend:["select","move","modify"],install(o){return e=o,e.tools.edit=X(e),e}}}function f(e,t=new WeakMap){if(e===null||typeof e!="object")return e;if(e instanceof Date)return new Date(e);if(e instanceof RegExp)return new RegExp(e);if(t.has(e))return t.get(e);const o=new e.constructor;return t.set(e,o),Array.isArray(e)?e.forEach((n,r)=>{o[r]=f(n,t)}):Object.keys(e).forEach(n=>{o[n]=f(e[n],t)}),o}function Z(e,t){e.element.add(t.element)}function _(e,t){e.element.remove(t.element)}function E(e,t,o=!1){const n=p(e,t.element.getSElement());if(t.data){const r=t.rawData,i=t.data;n.setData(o?r:i)}if(t.style){const r=t.rawStyle,i=t.style;n.setStyle(o?r:i)}if(t.name){const r=t.rawName,i=t.name;n.setName(o?r:i)}if(t.rotate){const r=t.rawRotate,i=t.rotate;n.setRotate(o?r:i)}return n}function ee(e){let t=[],n=-1,r=!1;function i(u){if(t.length>=50){t.shift(),t.push(u);return}t.push(u),n++}function l(u){r=!0;const d=t[n];let y=d.element;u==="forward"&&d.type==="add"||u==="back"&&d.type==="remove"?Z(e,d):u==="forward"&&d.type==="remove"||u==="back"&&d.type==="add"?_(e,d):d.type==="update"&&(u==="forward"?y=E(e,d,!1):y=E(e,d,!0)),e.emitter.emit("history",{max:50,pointer:n,type:d.type,element:y,data:d.data}),r=!1}function a(u){if(r)return;i({type:"add",element:u})}function c({element:u,data:d,style:y,rotate:L,name:T}){if(r)return;const I={type:"update",element:u,rawData:f(u.data),data:f(d),rawStyle:f(u.style),style:y,rawName:f(u.name),name:T,rawRotate:f(u.rotate),rotate:L};i(I)}function s(u){if(r)return;i({type:"remove",element:u})}const m={enabled:!1,enable(){m.enabled||(e.emitter.on("element:added",a),e.emitter.on("element:removed",s),e.emitter.on("element:updateBefore",c),m.enabled=!0)},close(){m.enabled&&(e.emitter.remove("element:added",a),e.emitter.remove("element:removed",s),e.emitter.remove("element:updateBefore",c),m.enabled=!1)},forward(){n!==t.length-1&&(n++,l("forward"))},back(){n!==-1&&(l("back"),n--)},clean(){t=[]}};return m}function te(){let e;return{type:"history",install(o){return e=o,e.tools.history=ee(e),e}}}const w={ap:F(),measure:W(),draw:z(),select:J(),move:Q(),modify:V(),edit:Y(),history:te()},ne=[{type:"ap"}],re=[{type:"measure"},{type:"draw"},{type:"select"},{type:"move"},{type:"modify"},{type:"edit"},{type:"history"}];function oe(e,t){for(const o of t)if(!e.getPluginByType(o))return!1;return!0}function le(e,t,o){if(t.depend&&t.depend.length>0){for(const r of t.depend){const i=w[r];i&&e.use(i,o)}return oe(e,t.depend)}return!0}function ae(e,t){const o=t??ne.concat(re);e.use(R()),e.use(j());for(const n of o){const r=w[n.type];e.use(r,t)}}function fe(e){const t=B({el:e.el,baseMap:e.baseMap,view:e.view}),{container:{baseMap:o},view:n}=t,r=[],i=S(),l={baseMap:o,view:n,emitter:i,get plugins(){return r},get map(){return t},getPluginByType(a){return r.find(c=>c.type===a)},use(a,c){return l.getPluginByType(a.type)||!le(l,a,c)||(a.install(l,c),r.push(a)),l}};return ae(l,e.plugins),l}export{F as a,fe as c};
