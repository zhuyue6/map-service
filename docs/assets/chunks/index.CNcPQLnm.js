import{I as T,w as x,_ as M,x as _,p as D,E as P,y as R,C as k}from"./index.DCeaUPRn.js";let b=0;function E(){return{type:"element",install(e){const t=e,a=[],o=e.emitter,r={create(n){b++;const{type:l,...i}=n,s=r.getLayerByType(l);if(!s)return;const c=i.id!==void 0?i.id:b,d=s.create({...i,id:c});return d?(r.add(d),d.getSElement().setProps({appLayerType:l,appElementId:d.id}),o.emit("element:created",d),d):void 0},add(n){const l=r.getLayerByType(n.type);l&&(l.add(n),o.emit("element:added",n))},remove(n){r.getLayerByType(n.type).remove(n),o.emit("element:removed",n)},getLayers(){return a},getLayerById(n){return a.find(l=>l.id===n)},getLayerByType(n){return a.find(l=>l.type===n)},addLayer(n){a.push(n)},removeLayer(n){const l=a.findIndex(i=>i.id===n.id);l!==-1&&a.splice(l,1)}};return t.element=r,t}}}function p(e,t){const a=t.props.appLayerType,o=t.props.appElementId,r=e.element.getLayerByType(a);if(!r)return;const n=r.getElementById(o);if(n)return n}let g=0,v=0;function N(e,t){g++;const{container:{layerManager:a}}=e.map,o=a.create({}),r=[];return{id:g,type:"ap",sElementType:"circle",create(n){return t.createElement(e,o,n)},add(n){r.findIndex(l=>l.id===n.id)===-1&&(o.add(n.getSElement()),r.push(n))},remove(n){const l=r.findIndex(i=>i.id===n.id);l!==-1&&(o.remove(n.getSElement()),r.splice(l,1))},getElements(){return r},getElementById(n){return r.find(l=>l.id===n)}}}function O(e,t,a){v++;const o={id:a.id??v,type:"ap",name:a.name,setName(r){e.emitter.emit("element:updateBefore",{element:o,name:r}),t.setName(r)},get rotate(){return t.rotate},setRotate(r){return e.emitter.emit("element:updateBefore",{element:o,rotate:r}),t.setRotate(r)},getSElement(){return t},get style(){return t.style},setStyle(r){e.emitter.emit("element:updateBefore",{element:o,style:r}),t.setStyle(r)},get data(){return t.data},setData(r){e.emitter.emit("element:updateBefore",{element:o,data:r}),t.setData(r)}};return o}function y(e,t){const a=t.getOlFeature().getGeometry();if(a){const o=M(a);e.setData(o)}}const j="#f0fae6";function A(e,t,a){const o=t.create({type:"circle",data:a.data,rotate:a.rotate,style:{fill:{color:j}}});return O(e,o,a)}function h(){let e;return{type:"ap",install(t){e=t;const a=N(e,{createElement:A});return e.element.addLayer(a),e}}}const ie=Object.freeze(Object.defineProperty({__proto__:null,createApPlugin:h,createElementPlugin:E,getElementBySElement:p,syncElementData:y},Symbol.toStringTag,{value:"Module"}));function C(){let e;return{type:"tool",install(t){return e=t,e.tools={},e}}}function G(e){const{interactiveManager:t,emitter:a}=e.map;function o(l){e.emitter.emit("measure",l)}const r=k(t),n={enabled:!1,enable(){n.enabled||(n.enabled=!0,a.on("measure",o),r.enable())},use(l){r.use(l)},close(){n.enabled&&(n.enabled=!1,a.remove("measure",o),r.close())}};return n}function W(){let e;return{type:"measure",install(t){return e=t,e.tools.measure=G(e),e}}}function q(e){var t;const{interactiveManager:a,emitter:o}=e.map,r=R(a),n=(t=e.element.getLayers())==null?void 0:t[0];let l=n==null?void 0:n.type;function i(c){const d=e.element.create({type:l,data:c.data});e.emitter.emit("draw",d)}const s={enabled:!1,enable(){s.enabled||(s.enabled=!0,o.on("draw",i),s.use(l),r.enable())},use(c){l=c;const d=e.element.getLayerByType(l);d&&r.use(d.sElementType)},close(){s.enabled&&(s.enabled=!1,o.remove("draw",i),r.close())}};return s}function z(){let e;return{type:"draw",install(t){return e=t,e.tools.draw=q(e),e}}}function F(e){const{interactiveManager:t,emitter:a}=e.map,o=P(t);function r(l){if(!l||l.length===0)return;const i=[];for(const s of l){const c=p(e,s);c&&i.push(c)}e.emitter.emit("select",i)}const n={enabled:!1,enable(){n.enabled||(n.enabled=!0,o.enable(),a.on("select",r))},close(){n.enabled&&(n.enabled=!1,a.remove("select",r),o.close())}};return n}function H(){let e;return{type:"select",install(t){return e=t,e.tools.select=F(e),e}}}function J(e){const{interactiveManager:t,emitter:a}=e.map,o=D(t,!1);function r(i){if(!i||i.length===0)return;const s=[];for(const c of i){const d=p(e,c);d&&(y(d,c),s.push(d))}e.emitter.emit("move",s)}const n=[],l={enabled:!1,add(i){n.findIndex(s=>s.id===i.id)===-1&&(o.add(i.getSElement()),n.push(i))},remove(i){o.remove(i.getSElement());const s=n.findIndex(c=>c.id===i.id);s!==-1&&n.splice(s,1)},clean(){for(const i of n)l.remove(i)},enable(){l.enabled||(l.enabled=!0,o.enable(),a.on("move",r))},close(){l.enabled&&(l.enabled=!1,a.remove("move",r),o.close())}};return l}function K(){let e;return{type:"move",install(t){return e=t,e.tools.move=J(e),e}}}function Q(e){const{interactiveManager:t,emitter:a}=e.map,o=_(t,!1);function r(i){if(!i||i.length===0)return;const s=[];for(const c of i){const d=p(e,c);d&&(y(d,c),s.push(d))}e.emitter.emit("modify",s)}const n=[],l={enabled:!1,add(i){n.findIndex(s=>s.id===i.id)===-1&&(o.add(i.getSElement()),n.push(i))},remove(i){o.remove(i.getSElement());const s=n.findIndex(c=>c.id===i.id);s!==-1&&n.splice(s,1)},clean(){for(const i of n)l.remove(i)},enable(){l.enabled||(l.enabled=!0,o.enable(),a.on("modify",r))},close(){l.enabled&&(l.enabled=!1,a.remove("modify",r),o.close())}};return l}function U(){let e;return{type:"modify",install(t){return e=t,e.tools.modify=Q(e),e}}}function V(e){const t=e.tools.select,a=e.tools.move,o=e.tools.modify;function r(i){e.emitter.emit("edit",i)}function n(i){a.clean(),o.clean();for(const s of i)a.add(s),o.add(s)}const l={enabled:!1,enable(){l.enabled||(l.enabled=!0,t.enable(),a.enable(),o.enable(),e.emitter.on("select",n),e.emitter.on("move",r),e.emitter.on("modify",r))},close(){l.enabled&&(l.enabled=!1,a.clean(),o.clean(),t.close(),a.close(),o.close(),e.emitter.on("select",n),e.emitter.remove("move",r),e.emitter.remove("modify",r))}};return l}function X(){let e;return{type:"edit",depend:["select","move","modify"],install(t){return e=t,e.tools.edit=V(e),e}}}function u(e,t=new WeakMap){if(e===null||typeof e!="object")return e;if(e instanceof Date)return new Date(e);if(e instanceof RegExp)return new RegExp(e);if(t.has(e))return t.get(e);const a=new e.constructor;return t.set(e,a),Array.isArray(e)?e.forEach((o,r)=>{a[r]=u(o,t)}):Object.keys(e).forEach(o=>{a[o]=u(e[o],t)}),a}function Y(e,t){e.element.add(t.element)}function Z(e,t){e.element.remove(t.element)}function w(e,t,a=!1){const o=p(e,t.element.getSElement());if(t.data){const r=t.rawData,n=t.data;o.setData(a?r:n)}if(t.style){const r=t.rawStyle,n=t.style;o.setStyle(a?r:n)}if(t.name){const r=t.rawName,n=t.name;o.setName(a?r:n)}if(t.rotate){const r=t.rawRotate,n=t.rotate;o.setRotate(a?r:n)}return o}function $(e){let t=[],a=-1,o=!1;function r(d){if(t.length>=50){t.shift(),t.push(d);return}t.push(d),a++}function n(d){o=!0;const m=t[a];let f=m.element;d==="forward"&&m.type==="add"||d==="back"&&m.type==="remove"?Y(e,m):d==="forward"&&m.type==="remove"||d==="back"&&m.type==="add"?Z(e,m):m.type==="update"&&(d==="forward"?f=w(e,m,!1):f=w(e,m,!0)),e.emitter.emit("history",{max:50,pointer:a,type:m.type,element:f,data:m.data}),o=!1}function l(d){o||r({type:"add",element:d})}function i({element:d,data:m,style:f,rotate:S,name:I}){if(o)return;const L={type:"update",element:d,rawData:u(d.data),data:u(m),rawStyle:u(d.style),style:f,rawName:u(d.name),name:I,rawRotate:u(d.rotate),rotate:S};r(L)}function s(d){o||r({type:"remove",element:d})}const c={enabled:!1,enable(){c.enabled||(e.emitter.on("element:added",l),e.emitter.on("element:removed",s),e.emitter.on("element:updateBefore",i),c.enabled=!0)},close(){c.enabled&&(e.emitter.remove("element:added",l),e.emitter.remove("element:removed",s),e.emitter.remove("element:updateBefore",i),c.enabled=!1)},forward(){a!==t.length-1&&(a++,n("forward"))},back(){a!==-1&&(n("back"),a--)},clean(){t=[]}};return c}function ee(){let e;return{type:"history",install(t){return e=t,e.tools.history=$(e),e}}}const B={ap:h(),measure:W(),draw:z(),select:H(),move:K(),modify:U(),edit:X(),history:ee()},te=[{type:"ap"}],ne=[{type:"measure"},{type:"draw"},{type:"select"},{type:"move"},{type:"modify"},{type:"edit"},{type:"history"}];function re(e,t){for(const a of t)if(!e.getPluginByType(a))return!1;return!0}function ae(e,t,a){if(t.depend&&t.depend.length>0){for(const o of t.depend){const r=B[o];r&&e.use(r,a)}return re(e,t.depend)}return!0}function oe(e,t){const a=t??te.concat(ne);e.use(E()),e.use(C());for(const o of a){const r=B[o.type];e.use(r,t)}}function se(e){const t=T({el:e.el,baseMap:e.baseMap,view:e.view}),{container:{baseMap:a},view:o}=t,r=[],n=x.emitter.createEmitter(),l={baseMap:a,view:o,emitter:n,get plugins(){return r},get map(){return t},getPluginByType(i){return r.find(s=>s.type===i)},use(i,s){return l.getPluginByType(i.type)||!ae(l,i,s)||(i.install(l,s),r.push(i)),l}};return oe(l,e.plugins),l}export{ie as c,se as u};
