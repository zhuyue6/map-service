import{g as P,c as B,a as S}from"./index.DAxF4nnB.js";import{c as $,a as M,b as k,d as x,e as D}from"./measure.z-onIDru.js";let g=0;function R(){return{type:"element",install(t){const r=t,n=[],o=t.emitter,i={create(l){g++;const{type:a,...s}=l,c=i.getLayerByType(a);if(!c)return;const m=s.id!==void 0?s.id:g,u=c.create({...s,id:m});return u?(i.add(u),u.getSElement().setProps({appLayerType:a,appElementId:u.id}),o.emit("element:created",u),u):void 0},add(l){const a=i.getLayerByType(l.type);a&&(a.add(l),o.emit("element:added",l))},remove(l){i.getLayerByType(l.type).remove(l),o.emit("element:removed",l)},getLayers(){return n},getLayerById(l){return n.find(s=>s.id===l)},getLayerByType(l){return n.find(s=>s.type===l)},addLayer(l){n.push(l)},removeLayer(l){const a=n.findIndex(s=>s.id===l.id);a!==-1&&n.splice(a,1)}};return r.element=i,r}}}function p(e,t){const r=t.props.appLayerType,n=t.props.appElementId,o=e.element.getLayerByType(r);if(!o)return;const i=o.getElementById(n);if(i)return i}let b=0,v=0;function O(e,t){b++;const{container:{layerManager:r}}=e.map,n=r.create({}),o=[];return{id:b,type:"ap",sElementType:"circle",create(l){return t.createElement(e,n,l)},add(l){o.findIndex(s=>s.id===l.id)===-1&&(n.add(l.getSElement()),o.push(l))},remove(l){const a=o.findIndex(s=>s.id===l.id);a!==-1&&(n.remove(l.getSElement()),o.splice(a,1))},getElements(){return o},getElementById(l){return o.find(s=>s.id===l)}}}function N(e,t,r){v++;const n={id:r.id??v,type:"ap",name:r.name,setName(o){e.emitter.emit("element:updateBefore",{element:n,name:o}),t.setName(o)},get rotate(){return t.rotate},setRotate(o){return e.emitter.emit("element:updateBefore",{element:n,rotate:o}),t.setRotate(o)},getSElement(){return t},get style(){return t.style},setStyle(o){e.emitter.emit("element:updateBefore",{element:n,style:o}),t.setStyle(o)},get data(){return t.data},setData(o){e.emitter.emit("element:updateBefore",{element:n,data:o}),t.setData(o)}};return n}function h(e,t){const n=t.getOlFeature().getGeometry();if(n){const o=P(n);e.setData(o)}}const C="#f0fae6";function A(e,t,r){const n=t.create({type:"circle",data:r.data,rotate:r.rotate,style:{fill:{color:C}}});return N(e,n,r)}function F(){let e;return{type:"ap",install(r){e=r;const n=O(e,{createElement:A});return e.element.addLayer(n),e}}}function j(){let e;return{type:"tool",install(r){return e=r,e.tools={},e}}}function G(e){const{interactiveManager:t,emitter:r}=e.map;function n(l){e.emitter.emit("measure",l)}const o=$(t),i={enabled:!1,enable(){i.enabled||(i.enabled=!0,r.on("measure",n),o.enable())},use(l){o.use(l)},close(){i.enabled&&(i.enabled=!1,r.remove("measure",n),o.close())}};return i}function W(){let e;return{type:"measure",install(r){return e=r,e.tools.measure=G(e),e}}}function q(e){var s;const{interactiveManager:t,emitter:r}=e.map,n=M(t);let i=((s=e.element.getLayers())==null?void 0:s[0]).type;function l(c){const m=e.element.create({type:i,data:c.data});e.emitter.emit("draw",m)}const a={enabled:!1,enable(){a.enabled||(a.enabled=!0,r.on("draw",l),a.use(i),n.enable())},use(c){i=c;const m=e.element.getLayerByType(i);m&&n.use(m.sElementType)},close(){a.enabled&&(a.enabled=!1,r.remove("draw",l),n.close())}};return a}function z(){let e;return{type:"draw",install(r){return e=r,e.tools.draw=q(e),e}}}function H(e){const{interactiveManager:t,emitter:r}=e.map,n=k(t);function o(l){if(!l||l.length===0)return;const a=[];for(const s of l){const c=p(e,s);c&&a.push(c)}e.emitter.emit("select",a)}const i={enabled:!1,enable(){i.enabled||(i.enabled=!0,n.enable(),r.on("select",o))},close(){i.enabled&&(i.enabled=!1,r.remove("select",o),n.close())}};return i}function J(){let e;return{type:"select",install(r){return e=r,e.tools.select=H(e),e}}}function K(e){const{interactiveManager:t,emitter:r}=e.map,n=x(t,!1);function o(a){if(!a||a.length===0)return;const s=[];for(const c of a){const m=p(e,c);m&&(h(m,c),s.push(m))}e.emitter.emit("move",s)}const i=[],l={enabled:!1,add(a){i.findIndex(c=>c.id===a.id)===-1&&(n.add(a.getSElement()),i.push(a))},remove(a){n.remove(a.getSElement());const s=i.findIndex(c=>c.id===a.id);s!==-1&&i.splice(s,1)},clean(){for(const a of i)l.remove(a)},enable(){l.enabled||(l.enabled=!0,n.enable(),r.on("move",o))},close(){l.enabled&&(l.enabled=!1,r.remove("move",o),n.close())}};return l}function Q(){let e;return{type:"move",install(r){return e=r,e.tools.move=K(e),e}}}function U(e){const{interactiveManager:t,emitter:r}=e.map,n=D(t,!1);function o(a){if(!a||a.length===0)return;const s=[];for(const c of a){const m=p(e,c);m&&(h(m,c),s.push(m))}e.emitter.emit("modify",s)}const i=[],l={enabled:!1,add(a){i.findIndex(c=>c.id===a.id)===-1&&(n.add(a.getSElement()),i.push(a))},remove(a){n.remove(a.getSElement());const s=i.findIndex(c=>c.id===a.id);s!==-1&&i.splice(s,1)},clean(){for(const a of i)l.remove(a)},enable(){l.enabled||(l.enabled=!0,n.enable(),r.on("modify",o))},close(){l.enabled&&(l.enabled=!1,r.remove("modify",o),n.close())}};return l}function V(){let e;return{type:"modify",install(r){return e=r,e.tools.modify=U(e),e}}}function X(e){const t=e.tools.select,r=e.tools.move,n=e.tools.modify;function o(a){e.emitter.emit("edit",a)}function i(a){r.clean(),n.clean();for(const s of a)r.add(s),n.add(s)}const l={enabled:!1,enable(){l.enabled||(l.enabled=!0,t.enable(),r.enable(),n.enable(),e.emitter.on("select",i),e.emitter.on("move",o),e.emitter.on("modify",o))},close(){l.enabled&&(l.enabled=!1,r.clean(),n.clean(),t.close(),r.close(),n.close(),e.emitter.on("select",i),e.emitter.remove("move",o),e.emitter.remove("modify",o))}};return l}function Y(){let e;return{type:"edit",depend:["select","move","modify"],install(r){return e=r,e.tools.edit=X(e),e}}}function f(e,t=new WeakMap){if(e===null||typeof e!="object")return e;if(e instanceof Date)return new Date(e);if(e instanceof RegExp)return new RegExp(e);if(t.has(e))return t.get(e);const r=new e.constructor;return t.set(e,r),Array.isArray(e)?e.forEach((n,o)=>{r[o]=f(n,t)}):Object.keys(e).forEach(n=>{r[n]=f(e[n],t)}),r}function Z(e,t){e.element.add(t.element)}function _(e,t){e.element.remove(t.element)}function E(e,t,r=!1){const n=p(e,t.element.getSElement());if(t.data){const o=t.rawData,i=t.data;n.setData(r?o:i)}if(t.style){const o=t.rawStyle,i=t.style;n.setStyle(r?o:i)}if(t.name){const o=t.rawName,i=t.name;n.setName(r?o:i)}if(t.rotate){const o=t.rawRotate,i=t.rotate;n.setRotate(r?o:i)}return n}function ee(e){let t=[],n=-1,o=!1;function i(u){if(t.length>=50){t.shift(),t.push(u);return}t.push(u),n++}function l(u){o=!0;const d=t[n];let y=d.element;u==="forward"&&d.type==="add"||u==="back"&&d.type==="remove"?Z(e,d):u==="forward"&&d.type==="remove"||u==="back"&&d.type==="add"?_(e,d):d.type==="update"&&(u==="forward"?y=E(e,d,!1):y=E(e,d,!0)),e.emitter.emit("history",{max:50,pointer:n,type:d.type,element:y,data:d.data}),o=!1}function a(u){if(o)return;i({type:"add",element:u})}function s({element:u,data:d,style:y,rotate:L,name:T}){if(o)return;const I={type:"update",element:u,rawData:f(u.data),data:f(d),rawStyle:f(u.style),style:y,rawName:f(u.name),name:T,rawRotate:f(u.rotate),rotate:L};i(I)}function c(u){if(o)return;i({type:"remove",element:u})}const m={enabled:!1,enable(){m.enabled||(e.emitter.on("element:added",a),e.emitter.on("element:removed",c),e.emitter.on("element:updateBefore",s),m.enabled=!0)},close(){m.enabled&&(e.emitter.remove("element:added",a),e.emitter.remove("element:removed",c),e.emitter.remove("element:updateBefore",s),m.enabled=!1)},forward(){n!==t.length-1&&(n++,l("forward"))},back(){n!==-1&&(l("back"),n--)},clean(){t=[]}};return m}function te(){let e;return{type:"history",install(r){return e=r,e.tools.history=ee(e),e}}}const w={ap:F(),measure:W(),draw:z(),select:J(),move:Q(),modify:V(),edit:Y(),history:te()},ne=[{type:"ap"}],re=[{type:"measure"},{type:"draw"},{type:"select"},{type:"move"},{type:"modify"},{type:"edit"},{type:"history"}];function oe(e,t){for(const r of t)if(!e.getPluginByType(r))return!1;return!0}function le(e,t,r){if(t.depend&&t.depend.length>0){for(const o of t.depend){const i=w[o];i&&e.use(i,r)}return oe(e,t.depend)}return!0}function ae(e,t){const r=t??ne.concat(re);e.use(R()),e.use(j());for(const n of r){const o=w[n.type];e.use(o,t)}}function ce(e){const t=B({el:e.el,baseMap:e.baseMap,view:e.view}),{container:{baseMap:r},view:n}=t,o=[],i=S(),l={baseMap:r,view:n,emitter:i,get plugins(){return o},get map(){return t},getPluginByType(a){return o.find(s=>s.type===a)},use(a,s){return l.getPluginByType(a.type)||!le(l,a,s)||(a.install(l,s),o.push(a)),l}};return ae(l,e.plugins),l}export{ce as c};
